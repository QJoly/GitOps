apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: joplin
    namespace: joplin
spec:
    interval: 15m
    chart:
        spec:
            chart: joplin
            version: '>=1.0.16'
            sourceRef:
                kind: HelmRepository
                name: rubxkube-charts
                namespace: flux-system
    values:
        define: 22300
        postgresql:
            enabled: true
            primary:
                readinessProbe:
                    initialDelaySeconds: 600
            auth:
                postgresPassword: changeme
                database: joplin
                username: joplinuser
                password: ENC[AES256_GCM,data:Mkiz9vxTDqDRG2tiKYI=,iv:PhxfCQxPjao0WtEfDwMJ+sWDslI47zEdczdbNjiEgnY=,tag:CjBb+PRZL3l43cWQNWktZg==,type:str]
            persistence:
                enabled: true
                existingClaim: ""
                storageClass: ""
                size: 8Gi
        common:
            app:
                servicePort: 80
                containerPort: 22300
            # deployment
            deployment:
                memoryRequest: null
                cpuRequest: null
                memoryLimit: null
                cpuLimit: null
                strategy:
                    type: Replace
            # container
            image:
                repositorySettings:
                    isPrivate: false
                    secretName: null
                repository: joplin/server
                tag: 2.14-beta
                pullPolicy: Always
            # ingress
            ingress:
                enabled: false
                hostName: joplin.une-tasse-de.cafe
                tls:
                    enabled: true
                    secretName: ""
                # For Ingress CRD
                ingressClassName: istio
                # For IngressRoute CRD
                isIngressRoute: true
                entrypoint: websecure
                # leave empty if you don't use, tls.enabled must be true and secretName must me empty
                certResolver: letsencrypt
            # env variables
            variables:
                secret: {}
                nonSecret:
                    DB_CLIENT: pg
                    POSTGRES_DATABASE: joplin
                    POSTGRES_USER: joplinuser
                    POSTGRES_PASSWORD: ENC[AES256_GCM,data:1V7EKS/DLDEevr6MqaA=,iv:z/Wi3k2ITy7Vna1A/VZry/WVjO2/vFgcL3iCtVfW4YA=,tag:p7Xw5NCuBvWde0YOI+ix3g==,type:str]
                    # if postgresql.enabled, must be RELEASE-NAME-postgresql (ex: my-wakapi-postgresql)
                    POSTGRES_HOST: joplin-postgresql
                    POSTGRES_PORT: "5432"
                    APP_BASE_URL: https://joplin.une-tasse-de.cafe
            # horizontal autoscaler
            hpa:
                enabled: false
                minReplicas: 1
                maxReplicas: 2
                avgCpuUtilization: 50
            # startupProbe
            startupProbeEnabled: false
            startupProbe:
                httpGet:
                    path: /
                    port: 22300
                periodSeconds: 10
                failureThreshold: 20
                timeoutSeconds: 1
            # readinessProbe
            readinessProbeEnabled: true
            readinessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 30
                failureThreshold: 2
                timeoutSeconds: 3
            # livenessProbe
            livenessProbeEnabled: true
            livenessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 60
                failureThreshold: 1
                timeoutSeconds: 3
            persistence:
                # no need for persistence if you use postgresql
                enabled: false
            tests:
                # default helm test method
                classicHttp:
                    enabled: false
                # curl using ingress.hostName as Host in header
                curlHostHeader:
                    enabled: true
                    path: /api/ping
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1p9z8z69fa63fa8pnxklq00e8k3556sc233wlp20na7cykthtgvgqwnvej5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA4LzQxbk9KRGhHYnhGb29s
            WWRGNnYzcStYaUE3MTZjSk00TENUOXNWUXhzClVuelNiMFBqYVJqOHBqMnk1MGdM
            eGZkemoxUXdaMWk1dHowUXlySU1tSHMKLS0tIGQ5T1FBQkhIOXhEMkE3UWE3Y2lK
            WUw1SWlIVXBSMUxhS3kwT2JJeENJV3cKn6EHQD7BQyn7uRV3scMSfujgNbhhvyhk
            e8FWmMBiq6+di2MaVYAO2mGHWzvjKuTeIHWYfoE/7wnidjJdz3s1Vw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age14ysm820ajay8wqslnkjqcewvq4tmeucth3a88qk4a7hl0mnwkfaqmj6xx5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBRdnppVVNod3JmcFVYUytW
            UjhDeGhiNkZSQUNSOVhaT1cxNXdTU0dHR2xvCllscWdZYUk4Um9IemZpanIrNWJ2
            NEVrcTdBaXJPekhMcHFFNE84RmhRSXMKLS0tIG92djZvbEp2aEpmNGdLL1h0WWV6
            cTk4QWlXNGo2clhPNEdod2RmVGtwUTQKid/zByqCaE3iaoYhGoxJc4CtktH4KaYb
            sBygn7CP5/42s1Tt2WzdSJn5fazxf3aE02s49bNCppMXvs2aQF21QA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-01-04T18:08:48Z"
    mac: ENC[AES256_GCM,data:1j7fJyX9vvOZZf3F2EuA2p8MZxIb4FpBl83IbybDQ4kGFzY/DgR0ylQPgDej9S+yza/WgL44C8vYNu6hBdaF3H9m13BfKCLbYSDkSM2R+FkZ1LF7LsOQqyrG6RHO7AlsycN9ogzlVEV1qSffluXjt6vtecAWPosvUAariw5pjKQ=,iv:MHxjHo4wFpRyU/FhQf184Z2f3oewLbj0YiG4k+DcxiM=,tag:RvGSaLRUOV10ATovJN/TWA==,type:str]
    pgp: []
    encrypted_regex: ^(password|POSTGRES_PASSWORD)$
    version: 3.8.1
