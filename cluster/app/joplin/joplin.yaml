apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: joplin
    namespace: joplin
spec:
    interval: 15m
    chart:
        spec:
            chart: joplin
            version: '>=1.0.16'
            sourceRef:
                kind: HelmRepository
                name: rubxkube-charts
                namespace: flux-system
    values:
        define: 22300
        postgresql:
            enabled: true
            primary:
                startupProbe:
                    enabled: true
                    timeoutSeconds: 5
                    periodSeconds: 30
                    failureThreshold: 60
                    initialDelaySeconds: 600
            auth:
                postgresPassword: changeme
                database: joplin
                username: joplinuser
                password: ENC[AES256_GCM,data:BNWJA6Iqmn4OUVjByQI=,iv:hHMM5H2OKTZE2AfdR8iqNJI8+jIhL6znb8fhEuTm2KM=,tag:RSW33jyBZ1Z8Z6GJxMQcIw==,type:str]
            persistence:
                enabled: true
                existingClaim: ""
                storageClass: ""
                size: 8Gi
        common:
            app:
                servicePort: 80
                containerPort: 22300
            # deployment
            deployment:
                memoryRequest: null
                cpuRequest: null
                memoryLimit: null
                cpuLimit: null
                strategy:
                    type: Replace
            # container
            image:
                repositorySettings:
                    isPrivate: false
                    secretName: null
                repository: joplin/server
                tag: 2.14-beta
                pullPolicy: Always
            # ingress
            ingress:
                enabled: false
                hostName: joplin.une-tasse-de.cafe
                tls:
                    enabled: true
                    secretName: ""
                # For Ingress CRD
                ingressClassName: istio
                # For IngressRoute CRD
                isIngressRoute: true
                entrypoint: websecure
                # leave empty if you don't use, tls.enabled must be true and secretName must me empty
                certResolver: letsencrypt
            # env variables
            variables:
                secret: {}
                nonSecret:
                    DB_CLIENT: pg
                    POSTGRES_DATABASE: joplin
                    POSTGRES_USER: joplinuser
                    POSTGRES_PASSWORD: ENC[AES256_GCM,data:xDOKLiIqmQqR/LLM1Ts=,iv:oj19kWwxQXW6adOoHYuRKYZYsLB3Te/hXePOO6KbLqo=,tag:naRpyS3Zc8U1/Ku3u9RTDA==,type:str]
                    # if postgresql.enabled, must be RELEASE-NAME-postgresql (ex: my-wakapi-postgresql)
                    POSTGRES_HOST: joplin-postgresql
                    POSTGRES_PORT: "5432"
                    APP_BASE_URL: https://joplin.une-tasse-de.cafe
            # horizontal autoscaler
            hpa:
                enabled: false
                minReplicas: 1
                maxReplicas: 2
                avgCpuUtilization: 50
            # startupProbe
            startupProbeEnabled: false
            startupProbe:
                httpGet:
                    path: /
                    port: 22300
                periodSeconds: 10
                failureThreshold: 20
                timeoutSeconds: 1
            # readinessProbe
            readinessProbeEnabled: true
            readinessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 30
                failureThreshold: 2
                timeoutSeconds: 3
            # livenessProbe
            livenessProbeEnabled: true
            livenessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 60
                failureThreshold: 1
                timeoutSeconds: 3
            persistence:
                # no need for persistence if you use postgresql
                enabled: false
            tests:
                # default helm test method
                classicHttp:
                    enabled: false
                # curl using ingress.hostName as Host in header
                curlHostHeader:
                    enabled: true
                    path: /api/ping
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1p9z8z69fa63fa8pnxklq00e8k3556sc233wlp20na7cykthtgvgqwnvej5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB0VXVFRVpjTlB3YWcwaGF0
            K25oL283YlNUV2JlR3pGM2QvZ1VwVWVDcFZZCmFwaTZrK1gxd2JtYTZ0Q21QNEdv
            R2lzaG4xNTRYb3BwT0JuRU5LcHNZWHcKLS0tIEM2a3R1NEhONFJQVS9ONHdFVHFa
            MkFUc3VTQURMc2s4TEVzZkZQN3J1WGsKw36SpyOgEGeESLuVBpL57q2x8sFssdqY
            qp20mglr5aq9H43PnxxZlKOnoLXR9jrWduS+p8DF7XWkdfYPmrdajw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age14ysm820ajay8wqslnkjqcewvq4tmeucth3a88qk4a7hl0mnwkfaqmj6xx5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBNN3NWRFRqUXozM2Y5RDkx
            L3VlNVpneWFtamY0TGdwY0RUT0hldktsMFdFCjg2UUpXbTJiREhxUmNJaUY4SWJL
            VlI1RFgxN295cEx1ZHl6Z1dheUp5MmsKLS0tIE9hc0l0VGozc1c5bGx1OUVVMjFB
            S1Q4cUNMYm9GWDcyZkJROXNJL0VQTkEKjfiprRAHbnboau69KJMLWKuGH1mZyvJn
            Pn1f0lP5h9V+rqs2UbjprbVxcKSws1/1Bybucb9PIdUi9YFQKHmxiw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-01-05T11:28:44Z"
    mac: ENC[AES256_GCM,data:CtL+oZUu2IxwwZ2L3KuETUxeH4mFSuiO15tp2hBzNMQ1WBxqvIZ4aLI63SNiZNNHJ4f54Cq5mZ2Li5x2ZgodJsS/7CptFt32PL+0nwKsKS0FujKBCL261plS2o9gHqp6QpCm42dZF7vK96vXfxorIQmUw6gDeYef+RTv1XDqxGY=,iv:6RY2C1lV+x+gjKJSk1YvwQqG4bRyZTAMWhrSgtvDh4E=,tag:6pGuxuiJogKeaAwLxlckZg==,type:str]
    pgp: []
    encrypted_regex: ^(password|POSTGRES_PASSWORD)$
    version: 3.8.1
