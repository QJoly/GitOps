apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: joplin
    namespace: joplin
spec:
    interval: 15m
    chart:
        spec:
            chart: joplin
            version: '>=1.0.16'
            sourceRef:
                kind: HelmRepository
                name: rubxkube-charts
                namespace: flux-system
    values:
        define: 22300
        postgresql:
            enabled: true
            auth:
                postgresPassword: changeme
                database: joplin
                username: joplinuser
                password: ENC[AES256_GCM,data:wne11Ovu+AB/C4i7yBg=,iv:MRj0x1srkwQxVHnSkBz+8rkZxeloVspp1MPuhAcoxKk=,tag:YKVYyL7FVToMcvdHRwZp7g==,type:str]
            persistence:
                enabled: true
                existingClaim: ""
                storageClass: ""
                size: 8Gi
        common:
            app:
                servicePort: 80
                containerPort: 22300
            # deployment
            deployment:
                memoryRequest: null
                cpuRequest: null
                memoryLimit: null
                cpuLimit: null
                strategy:
                    type: Replace
            # container
            image:
                repositorySettings:
                    isPrivate: false
                    secretName: null
                repository: joplin/server
                tag: 2.14-beta
                pullPolicy: Always
            # ingress
            ingress:
                enabled: false
                hostName: joplin.un-tasse-de.cafe
                tls:
                    enabled: true
                    secretName: ""
                # For Ingress CRD
                ingressClassName: istio
                # For IngressRoute CRD
                isIngressRoute: true
                entrypoint: websecure
                # leave empty if you don't use, tls.enabled must be true and secretName must me empty
                certResolver: letsencrypt
            # env variables
            variables:
                secret: {}
                nonSecret:
                    DB_CLIENT: pg
                    POSTGRES_DATABASE: joplin
                    POSTGRES_USER: joplinuser
                    POSTGRES_PASSWORD: ENC[AES256_GCM,data:Q+6V0aVAYw2qZC7ynSo=,iv:f6GNsS95uHTktg/2guYZ+GtVOxYK/HdUCM+zBvZs0sE=,tag:XVoBWCSgyUG/TqWq44gtYg==,type:str]
                    # if postgresql.enabled, must be RELEASE-NAME-postgresql (ex: my-wakapi-postgresql)
                    POSTGRES_HOST: joplin-postgresql
                    POSTGRES_PORT: "5432"
                    APP_BASE_URL: https://joplin.un-tasse-de.cafe
            # horizontal autoscaler
            hpa:
                enabled: false
                minReplicas: 1
                maxReplicas: 2
                avgCpuUtilization: 50
            # startupProbe
            startupProbeEnabled: false
            startupProbe:
                httpGet:
                    path: /
                    port: 22300
                periodSeconds: 10
                failureThreshold: 20
                timeoutSeconds: 1
            # readinessProbe
            readinessProbeEnabled: true
            readinessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 30
                failureThreshold: 2
                timeoutSeconds: 3
            # livenessProbe
            livenessProbeEnabled: true
            livenessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 60
                failureThreshold: 1
                timeoutSeconds: 3
            persistence:
                # no need for persistence if you use postgresql
                enabled: false
            tests:
                # default helm test method
                classicHttp:
                    enabled: false
                # curl using ingress.hostName as Host in header
                curlHostHeader:
                    enabled: true
                    path: /api/ping
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1p9z8z69fa63fa8pnxklq00e8k3556sc233wlp20na7cykthtgvgqwnvej5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSA5T3cvOEhYN2EyeUZIVVFB
            M21JcmdSYXZDUVRMdGlVbEsweWUzRmI1ZVM0CjM0VUlLN3k0RzlicFVyeXZBdFB6
            SFY5enFVdUZrNjA5RFpyZmNSNlRZZTgKLS0tIGljNUhkVGU3bTU2Zis1NDJhdXQz
            ZGhEK2F0RlhDY2Vtem1DTGMxb1BHRDQKYyzcaR+w6jHY0FzxktHzZ+t4QPIsNBPu
            pyJoVIeAUOZ4t4wsu//lHwkzCblYHuCjII4Y9ynSQORgKlczXmZYjw==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age14ysm820ajay8wqslnkjqcewvq4tmeucth3a88qk4a7hl0mnwkfaqmj6xx5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBicXhFYkIxR090Y2xTVngy
            SUgvV2ZQenQ0bmRrV0RSUWUzLzNyckltcmdFCkJTUjl6MHFKMjZPZ1NwWmxic3Q0
            KzRlKzNQT1B4SmxRTCtQa0J4WVJpaU0KLS0tIGYrRWtCZXlUdUlwUUxhaVhQMlhN
            cGlOeEw4b0RoajZqSXVtU0t4WU5IZGMKOuqz3gxLGttQZptnlMWl7rcjuBb+KoXN
            re3k+0G37Z9J+XrtXlOmWyokXZluj6b/uXa+yUUtW6NXhQ6yoDZhow==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-01-04T17:11:07Z"
    mac: ENC[AES256_GCM,data:wxjLv8tAYNSHJamVfdr2zLzQxLcBycst9o5O/SpGWGAc1GB0TmijMzW4ILLMyCJr/BM2L/prItorTZeu/vh01qaNbMuEEvQZa1xSkz2N4yx+xWgqmtjCAfMU87+EsYiOsQ8/NH4MnwuTYFNm2LrsKdJnUwIwa6uJCkQ3Ko2YVH4=,iv:TwMHJcF4oHuGInbDpbZ7TWef8JyItu9QoDLhaVoDfi8=,tag:3oClnBY4ax2c9LlEBugHGw==,type:str]
    pgp: []
    encrypted_regex: ^(password|POSTGRES_PASSWORD)$
    version: 3.8.1
