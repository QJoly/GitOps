apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: joplin
    namespace: joplin
spec:
    interval: 15m
    chart:
        spec:
            chart: joplin
            version: '>=1.0.16'
            sourceRef:
                kind: HelmRepository
                name: rubxkube-charts
                namespace: flux-system
    values:
        define: 22300
        postgresql:
            enabled: true
            primary:
                readinessProbe:
                    initialDelaySeconds: 190
            auth:
                postgresPassword: changeme
                database: joplin
                username: joplinuser
                password: ENC[AES256_GCM,data:yjsAZlCLco5App60gAE=,iv:odSnEdctoOIK7gcv/bVvOFFReolLtJ9sEZ/X7kwxMh8=,tag:qiD9BzLzYb2JFmpI0cmxXA==,type:str]
            persistence:
                enabled: true
                existingClaim: ""
                storageClass: ""
                size: 8Gi
        common:
            app:
                servicePort: 80
                containerPort: 22300
            # deployment
            deployment:
                memoryRequest: null
                cpuRequest: null
                memoryLimit: null
                cpuLimit: null
                strategy:
                    type: Replace
            # container
            image:
                repositorySettings:
                    isPrivate: false
                    secretName: null
                repository: joplin/server
                tag: 2.14-beta
                pullPolicy: Always
            # ingress
            ingress:
                enabled: false
                hostName: joplin.une-tasse-de.cafe
                tls:
                    enabled: true
                    secretName: ""
                # For Ingress CRD
                ingressClassName: istio
                # For IngressRoute CRD
                isIngressRoute: true
                entrypoint: websecure
                # leave empty if you don't use, tls.enabled must be true and secretName must me empty
                certResolver: letsencrypt
            # env variables
            variables:
                secret: {}
                nonSecret:
                    DB_CLIENT: pg
                    POSTGRES_DATABASE: joplin
                    POSTGRES_USER: joplinuser
                    POSTGRES_PASSWORD: ENC[AES256_GCM,data:2hAqzvLX2OB7eFEA2Nc=,iv:Z8SThRYHilpW7fRzwaYnoYBASwk9qnp5RWzvC/7trvM=,tag:Depjlv2R5aW4vsiAxjmrAQ==,type:str]
                    # if postgresql.enabled, must be RELEASE-NAME-postgresql (ex: my-wakapi-postgresql)
                    POSTGRES_HOST: joplin-postgresql
                    POSTGRES_PORT: "5432"
                    APP_BASE_URL: https://joplin.une-tasse-de.cafe
            # horizontal autoscaler
            hpa:
                enabled: false
                minReplicas: 1
                maxReplicas: 2
                avgCpuUtilization: 50
            # startupProbe
            startupProbeEnabled: false
            startupProbe:
                httpGet:
                    path: /
                    port: 22300
                periodSeconds: 10
                failureThreshold: 20
                timeoutSeconds: 1
            # readinessProbe
            readinessProbeEnabled: true
            readinessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 30
                failureThreshold: 2
                timeoutSeconds: 3
            # livenessProbe
            livenessProbeEnabled: true
            livenessProbe:
                tcpSocket:
                    port: 22300
                initialDelaySeconds: 30
                periodSeconds: 60
                failureThreshold: 1
                timeoutSeconds: 3
            persistence:
                # no need for persistence if you use postgresql
                enabled: false
            tests:
                # default helm test method
                classicHttp:
                    enabled: false
                # curl using ingress.hostName as Host in header
                curlHostHeader:
                    enabled: true
                    path: /api/ping
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1p9z8z69fa63fa8pnxklq00e8k3556sc233wlp20na7cykthtgvgqwnvej5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBjWG5kU1c4a2ZaZ3FqVHox
            ZzltNUJQV0pyOFZ1T1V5akpEMCtNUllxeUdZCmVNUXZOR2VsRkI1NXpUai82NVV0
            QzZDbXVDY3dSOGZnYjJuSEw3SHc0RDgKLS0tIFdaVEZ2RURhcmhqZmJVOUZ5OEFn
            T2RKYWZETWdoNWJnRE0rMVVTQnR5YWcKbGyz2G1W4p+ivhcogM7JV0k8LruvZqXI
            nqHlAuCZmedWfJDGbSWd3m8IGVeJ5b9p3aJAzhHFAxnCGL9Se1qQUQ==
            -----END AGE ENCRYPTED FILE-----
        - recipient: age14ysm820ajay8wqslnkjqcewvq4tmeucth3a88qk4a7hl0mnwkfaqmj6xx5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBGa3k4bnpNN0ZyRWJLY3Ns
            K1R2ME1aMUhQWTJ4M2g1K0lqRTJVM2p5N3lRCklLa2JWdHgrcFJFaVJTMURSc05s
            NnFSSmFDWHRLYXpFQ2VyOUsvcllpSjgKLS0tIDJtN0JIS0VreWhNK2t2eU5XZXZN
            MXdYbTgwTEloUHZsMERiQk11WEZJclEKnnmWNAzAPCWtBNcrM4r5J0WJjrS0EHgc
            IOt0qLb3QS3fX0WnHPnL9e1w4NWyPtlCmt6Y8xorJX1Q4Ucgb2tXgQ==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-01-04T17:45:09Z"
    mac: ENC[AES256_GCM,data:M/Yg3ujwb48JfjSqSUOrui15TfoTukyYDulGKDqMcfMGX2legE/cBIR3o8OFj1YlgkegQalWGbVPYzYmGGH6P6xt3j/YyIV4zKk2YY+7iYGamXXpCdQFx1WxRAv/wtCOlQsIEJKKw+KVoPnpEE9KSNE7Ah9kY6/Wr39KFrPb8Z0=,iv:iTctHoBNoMIlarldmP7FZH+L6hghIdatp7l/O+IM5Dg=,tag:ZvlsGfk1RBOMo6puJTGDRg==,type:str]
    pgp: []
    encrypted_regex: ^(password|POSTGRES_PASSWORD)$
    version: 3.8.1
